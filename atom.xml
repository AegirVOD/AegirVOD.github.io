<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>AegirVOD&#39;s Blog</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2021-01-05T10:27:48.723Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>AegirVOD</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Pacman cannot update EFI-installed grub after upgrading kernel</title>
    <link href="http://example.com/2021/01/05/Pacman-cannot-update-EFI-installed-grub-after-upgrading-kernel/"/>
    <id>http://example.com/2021/01/05/Pacman-cannot-update-EFI-installed-grub-after-upgrading-kernel/</id>
    <published>2021-01-05T10:08:38.000Z</published>
    <updated>2021-01-05T10:27:48.723Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0-Problem-Introduction"><a href="#0-Problem-Introduction" class="headerlink" title="0. Problem Introduction"></a>0. Problem Introduction</h2><hr><p>I switched to Arch Linux from Ubuntu 2 weeks ago (that’s another story), so I’m a 100% noob in Arch Linux. One day, after I did my daily pacman -Syu, my system couldn’t boot anymore. It stucked in grub, and showed this:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[FAILED] Failed to start load kernel modules</span><br><span class="line">See &#39;systemctl status systemd-modules-load.service** for details.</span><br></pre></td></tr></table></figure><p>Besides that, NOTHINGS else.</p><hr><h2 id="1-Problem-Analysis"><a href="#1-Problem-Analysis" class="headerlink" title="1. Problem Analysis"></a>1. Problem Analysis</h2><hr><p>So I did some research, unfortunately, nobody has occured such kind of problem, not in the English community, nor in the Chinese community. Normally, they would have another line of [FAILED] in the error, such as <code>[FAILED]faild to mount /boot/efi</code><br>Also, I remembered that I have updated the kernel from 5.9 to 5.10, I guessed there was something to do with that.<br>So I suggest the problem is just the kernel cannot be loaded, nothing else, no problem of mounting or other shits, which makes it actually more simple.</p><hr><h2 id="2-Solving-The-Problem"><a href="#2-Solving-The-Problem" class="headerlink" title="2. Solving The Problem"></a>2. Solving The Problem</h2><hr><p>I tried to follow the instruction that the system gave me, but since I cannot enter the system, I cannot use <code>systemctl</code>. So I entered into LiveCD (Luckily I have one in my hand), mounted the system, <code>chroot</code>, all good. I typed <code>systemctl status systemd-modules-load.service</code>, and I got:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Running in chroot, ignoring status.</span><br></pre></td></tr></table></figure><p>After searching, I understanded that I cannot use <code>systemctl</code> inside <code>chroot</code>, due to a systemd feature.</p><p>So I switched to another method. While I was in grub, I clicked ‘e’ to edit the booting command (temporarily editting grub.cfg), and added <code>rescue</code> at the end of the line in order to boot in to rescue mode:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linux   &#x2F;boot&#x2F;vmlinuz-linux root&#x3D;UUID&#x3D;14d44e03-023a-4c9a-8bd3-4e326116ac43 rw  loglevel&#x3D;3 rescue</span><br></pre></td></tr></table></figure><p>Luckily, I successfully booted into rescue mode. And I re-installed the already-uninstalled old kernel(5.9) with these commandes.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Enter the directory where the old packages are stored.</span></span><br><span class="line"><span class="built_in">cd</span> /var/cache/pacman/pkg</span><br><span class="line"><span class="comment">#Find old kernel version number</span></span><br><span class="line">ls | grep linux-headers</span><br><span class="line"><span class="comment">#I got linux-headers-5.9.14.arch1-1-x86_64.pkg.tar.zst</span></span><br><span class="line"><span class="comment">#list all related packages</span></span><br><span class="line">ls | grep 5.9.14</span><br><span class="line"><span class="comment">#I got linux-5.9.14.arch1-1-x86_64.pkg.tar.zst and linux-headers-5.9.14.arch1-1-x86_64.pkg.tar.zst</span></span><br><span class="line"><span class="comment">#Instally old kernel from local packages</span></span><br><span class="line">pacman -U linux-5.9.14.arch1-1-x86_64.pkg.tar.zst linux-headers-5.9.14.arch1-1-x86_64.pkg.tar.zst</span><br><span class="line"><span class="comment">#reboot the system</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><p>And the magic worked, I successfully entered the system.</p><p>After that I did some tests, it turns out that once I upgrade the kernel, the same problem shows again. So, for further testing, I installed the lts kernel (which is more stable) by <code>sudo pacman -S linux-lts</code>. But the grub never showed the lts kernel option for me to boot, and after rebooting, <code>uname -r</code> still shows <code>5.9.14-arch-1-1</code>, which means the installation has failed. I checked the pacman journal, updated grub by <code>grub-mkconfig -o /boot/grub/grub.cfg</code>, even manually checked several times that the <code>grub.cfg</code> is correct, all is well, but still nothing changed in the boot menu.</p><p>So I doubted that there are two existing <code>grub.cfg</code> files, and <code>pacman</code> (and myself) is always updating the <code>/boot/grub/grub.cfg</code>, but the system is actually reading the other file. Then I realized that when I installed Arch Linux, I installed the grub in the EFI partition. Problem found. Now it’s time to solve it.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line">fdisk -l <span class="comment">#List all partitions</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#/dev/nvme1n1p1      2048   1085439   1083392   529M Environnement de récupération Windows</span></span><br><span class="line"><span class="comment">#/dev/nvme1n1p2   1085440   1290239    204800   100M Système EFI</span></span><br><span class="line"><span class="comment">#/dev/nvme1n1p3   1290240   1323007     32768    16M Réservé Microsoft</span></span><br><span class="line"><span class="comment">#/dev/nvme1n1p4   1323008 417500934 416177927 198.4G Données de base Microsoft</span></span><br><span class="line"><span class="comment">#/dev/nvme1n1p5 417501184 419088383   1587200   775M Environnement de récupération Windows</span></span><br><span class="line"><span class="comment">#/dev/nvme1n1p6 419090432 500117503  81027072  38.6G Système de fichiers Linux</span></span><br><span class="line"></span><br><span class="line">mkdir <span class="built_in">test</span></span><br><span class="line">mount /dev/nvme1n1p2 <span class="built_in">test</span></span><br><span class="line">grub-mkconfig -o <span class="built_in">test</span>/grub/grub.cfg</span><br><span class="line">umount /dev/nvme1n1p2</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><p>All done. After rebooting, grub menu shows additional kernels, and pacman upgrades the correct <code>grub.cfg</code>.</p><hr><h2 id="3-Summary"><a href="#3-Summary" class="headerlink" title="3. Summary"></a>3. Summary</h2><hr><p>After this not-so-good experience I realized that this happens because I lack tons of Linux basic knowledge, especially for <strong>Arch Linux</strong>. I don’t know how the grub work, I don’t know how the <code>systemctl</code> work, nor the <code>chroot</code>, I didn’t even remembered that I have installed the grub in EFI partition!<br>Guess next time I’ll try to <strong>UNDERSTAND</strong> rather than <strong>USING</strong> a feature, a command, or an entire system.</p><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;0-Problem-Introduction&quot;&gt;&lt;a href=&quot;#0-Problem-Introduction&quot; class=&quot;headerlink&quot; title=&quot;0. Problem Introduction&quot;&gt;&lt;/a&gt;0. Problem Introduc</summary>
      
    
    
    
    <category term="Arch Linux" scheme="http://example.com/categories/Arch-Linux/"/>
    
    <category term="Issues" scheme="http://example.com/categories/Arch-Linux/Issues/"/>
    
    
    <category term="Arch Linux" scheme="http://example.com/tags/Arch-Linux/"/>
    
    <category term="Issues" scheme="http://example.com/tags/Issues/"/>
    
  </entry>
  
  <entry>
    <title>The Real Hello-World</title>
    <link href="http://example.com/2021/01/04/The-Real-Hello-World/"/>
    <id>http://example.com/2021/01/04/The-Real-Hello-World/</id>
    <published>2021-01-04T13:53:16.000Z</published>
    <updated>2021-01-05T10:16:58.760Z</updated>
    
    <content type="html"><![CDATA[<p>Actually this is the first time I use markdown, and this is just a test article to lear how to markdown. So…it would look kinda clumsy or dumb.</p><p>Still have no idea how can I insert image into hexo articles.</p><p>Well, since this is the first-ever blog of mine, I gotta write something down, right?</p><h2 id="Why-did-I-wanted-to-start-blogging"><a href="#Why-did-I-wanted-to-start-blogging" class="headerlink" title="Why did I wanted to start blogging?"></a>Why did I wanted to start blogging?</h2><hr><p>It’s pretty simple. I had some really great (I belive) ideas, and sometimes I solved some really difficult problems (for me, I need a place to store them so that they don’t disappear from my tiny brain.</p><p>And bang, here we are!</p><h2 id="What-IS-this-blog"><a href="#What-IS-this-blog" class="headerlink" title="What IS this blog?"></a>What IS this blog?</h2><hr><p>For now, I’m planning to use my blog to recordm or save, my ideas in developpement, and some difficulties I’ve met during the process of developping (or using Arch Linux because everyday I get tons of them). And maybe, I say MAYBE, someday I would also add some kind of journal of my cycling training.</p><h2 id="What-else-do-I-wanna-say"><a href="#What-else-do-I-wanna-say" class="headerlink" title="What else do I wanna say ?"></a>What else do I wanna say ?</h2><hr><p>To be honest, nothing. I’m not a guy who is good at talking, nor writing.<br>So..</p><h3 id="Welcome"><a href="#Welcome" class="headerlink" title="Welcome!"></a>Welcome!</h3><h3 id="Bienvenue"><a href="#Bienvenue" class="headerlink" title="Bienvenue !"></a>Bienvenue !</h3><h3 id="欢迎光临"><a href="#欢迎光临" class="headerlink" title="欢迎光临 !"></a>欢迎光临 !</h3>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Actually this is the first time I use markdown, and this is just a test article to lear how to markdown. So…it would look kinda clumsy or</summary>
      
    
    
    
    <category term="Personal Records" scheme="http://example.com/categories/Personal-Records/"/>
    
    
    <category term="Personal" scheme="http://example.com/tags/Personal/"/>
    
  </entry>
  
</feed>
